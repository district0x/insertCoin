<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lobby</title>
    <script src="https://unpkg.com/@metamask/detect-provider/dist/detect-provider.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script src="contractABI.js"></script>
    <style>
      /* Add your CSS styles here */
    </style>
  </head>
  <body>
    <div class="container">
      <div class="matching-pool">
        <h2>Matching Pool: <span id="matchingPoolAmount"></span></h2>
      </div>
      <div class="header">
        <h2>Donate to Match</h2>
        <input type="number" id="donationAmountUsdInput" placeholder="Enter donation amount in USD" step="0.01" />
        <input type="text" id="donationMatchIdInput" placeholder="Enter Match ID to donate to" />
        <button id="donateButton" onclick="donateToMatch()">Donate</button>
        <h1>Lobby</h1>
        <p id="userAddress"></p>
      </div>
      <div class="content">
        <!-- Add other content here -->
        <h2>Player Information</h2>
        <p id="player1"></p>
        <p id="player2"></p>
        <p id="matchId"></p>
        <input type="number" id="matchAmountUsdInput" placeholder="Enter match amount in USD" step="0.01" style="display: none;"/>
        <button id="startMatchButton" onclick="startMatch()">Start Match</button>
        <span id="matchAmountDisplay"></span>
        <input type="text" id="joinMatchIdInput" placeholder="Enter Match ID to join" style="display: none;"/>
        <span id="joinMatchIdDisplay"></span>
        <button id="joinMatchButton" onclick="joinMatch()">Join Match</button>
        <span id="joinMatchAmountDisplay"></span>
        <input
          type="text"
          id="winnerAddressInput"
          placeholder="Enter winner's address"
        />
        <input
          type="text"
          id="closeMatchIdInput"
          placeholder="Enter Match ID to close"
        />
        <button id="closeMatchButton" onclick="closeMatch()">
          Close Match
        </button>
        <h2>Current Matches</h2>
        <div id="matchesContainer"></div>
      </div>
    </div>

    <script type="text/javascript">
      // Contract address
      const contractAddress = "0x8d7b8A8ba6f29615810FAd89Fe2F34c359784De9";

      // Web3 initialization
      let web3;
      let contract;

      const userAddressElement = document.getElementById("userAddress");
      web3 = new Web3("https://sepolia.base.org");

      async function checkMetaMask() {
        const provider = await detectEthereumProvider();

        if (provider) {
          console.log("MetaMask is installed!");
          return true;
        } else {
          console.log("Please install MetaMask!");
          return false;
        }
      }

      async function loginWithMetaMask() {
        const accounts = await ethereum.request({
          method: "eth_requestAccounts",
        });
        const address = accounts[0];
        userAddressElement.textContent = "Logged in with address: " + address;
        localStorage.setItem("loggedInUserWallet", address);
      }

      async function getLoggedInUserWallet() {
        const accounts = await ethereum.request({ method: "eth_accounts" });
        return accounts[0];
      }

      async function displayPlayerInfo() {
        const player1Name = getURLParameter("player1");
        const player2Name = getURLParameter("player2");

        // Retrieve player wallet addresses from local storage if available
        const player1Wallet = localStorage.getItem("player1_wallet") || "";
        const player2Wallet = localStorage.getItem("player2_wallet") || "";

        document.getElementById("player1").textContent =
          "Player 1: " + player1Name + " - Wallet: " + player1Wallet;
        document.getElementById("player2").textContent =
          "Player 2: " + player2Name + " - Wallet: " + player2Wallet;
      }

      async function updateTransactionData() {
        const loggedInUserWallet = await getLoggedInUserWallet();
        const player1Name = getURLParameter("player1");
        const player2Name = getURLParameter("player2");

        if (player1Name === loggedInUserWallet) {
          localStorage.setItem("player1_wallet", loggedInUserWallet);
        } else if (player2Name === loggedInUserWallet) {
          localStorage.setItem("player2_wallet", loggedInUserWallet);
        }
      }

      function getURLParameter(name) {
        const url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        const regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)");
        const results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return "";
        const value = decodeURIComponent(results[2].replace(/\+/g, " "));
        return name === "match_amount_usd" ? parseInt(value) : value;
      }

      async function getEthPriceInUsd() {
        const response = await fetch(
          "https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd"
        );
        const data = await response.json();
        return data.ethereum.usd;
      }

      async function getMatchAmountInEth(matchAmountUsd) {
        const response = await fetch(
          "https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd"
        );
        const data = await response.json();
        const ethPriceInUsd = data.ethereum.usd;
        const matchAmountEth = (matchAmountUsd / ethPriceInUsd).toFixed(18);
        return matchAmountEth;
      }

      async function displayMatchingPoolAmount() {
        try {
          const matchingPoolAmount = await contract.methods.matchingPool().call();
          const ethPriceInUsd = await getEthPriceInUsd();
          const matchingPoolAmountUsd = (
            parseFloat(web3.utils.fromWei(matchingPoolAmount, "ether")) * ethPriceInUsd
          ).toFixed(2);
          document.getElementById("matchingPoolAmount").textContent = `$${matchingPoolAmountUsd}`;
        } catch (error) {
          console.error("Error displaying Matching Pool amount:", error);
        }
      }

      async function startMatch() {
        const matchAmountUsdInput = document.getElementById("matchAmountUsdInput");
        const matchAmountUsd = parseFloat(matchAmountUsdInput.value);
        const matchAmountDisplay = document.getElementById("matchAmountDisplay");
        const joinMatchIdInput = document.getElementById("joinMatchIdInput");
        const joinMatchIdDisplay = document.getElementById("joinMatchIdDisplay");

        if (!isNaN(matchAmountUsd) && matchAmountUsd > 0) {
          const matchAmountEth = await getMatchAmountInEth(matchAmountUsd);
          if (matchAmountEth === "0") {
            console.error("Invalid USD amount.");
            return;
          }

          const matchAmountWei = web3.utils.toWei(matchAmountEth, "ether");
          const fromAddress = ethereum.selectedAddress;

          try {
            await contract.methods
              .startMatch(matchAmountWei)
              .send({
                from: fromAddress,
                value: matchAmountWei,
              })
              .on("transactionHash", function (hash) {
                console.log("Transaction hash:", hash);
              })
              .on("receipt", function (receipt) {
                console.log("Receipt:", receipt);
                const matchId = receipt.events.MatchStarted.returnValues.matchId;
                document.getElementById("matchId").textContent = "Match ID: " + matchId;
                localStorage.setItem("player1_address", fromAddress);

                // Set the match ID for joining and hide/display the respective elements
                joinMatchIdInput.value = matchId;
                joinMatchIdInput.style.display = "none";
                joinMatchIdDisplay.textContent = `Match ID: ${matchId}`;
              })
              .on("error", function (error) {
                console.error("Error:", error);
              });

            const player1Wallet = await getLoggedInUserWallet();
            document.getElementById("player1").textContent =
              "Player 1: " + getURLParameter("player1") + " - Wallet: " + player1Wallet;

            // Hide the input field and display the entered amount
            matchAmountUsdInput.style.display = "none";
            matchAmountDisplay.textContent = `$${matchAmountUsd}`;
          } catch (error) {
            console.error("Failed to start match:", error);
          }
        } else {
          console.error("Invalid match amount input.");
        }
      }

      async function joinMatch(matchId) {
        console.log("joinMatch called with matchId:", matchId);

        let matchAmountUsd;
        if (!matchId) {
          matchId = document.getElementById("joinMatchIdInput").value;
          matchAmountUsd = parseFloat(document.getElementById("matchAmountUsdInput").value);
        } else {
          matchAmountUsd = parseFloat(document.getElementById(`matchAmountInput_${matchId}`).value);
        }

        console.log("matchId:", matchId);
        console.log("matchAmountUsd:", matchAmountUsd);

        if (!matchId || isNaN(matchAmountUsd) || matchAmountUsd <= 0) {
          console.error("Invalid match ID or match amount input.");
          return;
        }

        const matchAmountEth = await getMatchAmountInEth(matchAmountUsd);
        if (matchAmountEth === "0") {
          console.error("Invalid USD amount.");
          return;
        }

        const matchAmountWei = web3.utils.toWei(matchAmountEth, "ether");
        const fromAddress = ethereum.selectedAddress;

        console.log("matchAmountEth:", matchAmountEth);
        console.log("matchAmountWei:", matchAmountWei);
        console.log("fromAddress:", fromAddress);

        // Ensure contract and web3 are initialized
        if (!contract) {
          console.error("Contract is not initialized.");
          return;
        }

        try {
          await contract.methods
            .joinMatch(matchId)
            .send({
              from: fromAddress,
              value: matchAmountWei,
            })
            .on("transactionHash", function (hash) {
              console.log("Transaction hash:", hash);
            })
            .on("receipt", function (receipt) {
              console.log("Receipt:", receipt);
              localStorage.setItem("player2_address", fromAddress);
            })
            .on("error", function (error) {
              console.error("Error:", error);
            });

          const player2Wallet = await getLoggedInUserWallet();
          document.getElementById("player2").textContent =
            "Player 2: " + getURLParameter("player2") + " - Wallet: " + player2Wallet;

          // Hide the input field and display the entered amount
          document.getElementById("joinMatchAmountUsdInput").style.display = "none";
          document.getElementById("joinMatchAmountDisplay").textContent = `$${matchAmountUsd}`;
        } catch (error) {
          console.error("Failed to join match:", error);
        }
      }
      async function closeMatch() {
        const matchId = document.getElementById("closeMatchIdInput").value;

        const winnerAddress =
          document.getElementById("winnerAddressInput").value;

        if (!winnerAddress) {
          console.error("Winner address not provided.");
          return;
        }

        try {
          await contract.methods
            .closeMatch(matchId, winnerAddress)
            .send({
              from: ethereum.selectedAddress,
            })
            .on("transactionHash", function (hash) {
              console.log("Transaction hash:", hash);
            })
            .on("receipt", async function (receipt) {
              console.log("Receipt:", receipt);
              const matchClosedEvent = receipt.events.MatchClosed;
              const winnerAmountWei =
                matchClosedEvent.returnValues.winnerAmount;
              const multisigAmountWei =
                matchClosedEvent.returnValues.multisigAmount;
              const poolAmountWei = matchClosedEvent.returnValues.poolAmount;

              const winnerAmountEth = web3.utils.fromWei(
                winnerAmountWei,
                "ether"
              );
              const multisigAmountEth = web3.utils.fromWei(
                multisigAmountWei,
                "ether"
              );
              const poolAmountEth = web3.utils.fromWei(poolAmountWei, "ether");

              const ethPriceInUsd = await getEthPriceInUsd();

              const winnerAmountUsd = (
                parseFloat(winnerAmountEth) * ethPriceInUsd
              ).toFixed(2);
              const multisigAmountUsd = (
                parseFloat(multisigAmountEth) * ethPriceInUsd
              ).toFixed(2);
              const poolAmountUsd = (
                parseFloat(poolAmountEth) * ethPriceInUsd
              ).toFixed(2);

              const matchResult = `
                      Match Result:
                      Winning Player Address: ${winnerAddress}
                      Winning Player Amount: ${winnerAmountUsd} USD
                      Amount to Matching Pool: ${poolAmountUsd} USD
                      Amount to Contract Owner: ${multisigAmountUsd} USD
                    `;
              alert(matchResult);
            })
            .on("error", function (error) {
              console.error("Error:", error);
            });

          console.log("Match closed successfully.");
        } catch (error) {
          console.error("Failed to close match:", error);
        }
      }

      async function donateToMatch() {
        const donationAmountUsd = parseFloat(document.getElementById("donationAmountUsdInput").value);
        const matchId = document.getElementById("donationMatchIdInput").value;

        if (isNaN(donationAmountUsd) || donationAmountUsd <= 0 || !matchId) {
          console.error("Invalid donation amount or match ID.");
          return;
        }

        const donationAmountEth = await getMatchAmountInEth(donationAmountUsd);
        if (donationAmountEth === "0") {
          console.error("Invalid USD amount.");
          return;
        }

        const donationAmountWei = web3.utils.toWei(donationAmountEth, "ether");
        const fromAddress = ethereum.selectedAddress;

        try {
          await contract.methods
            .donateToMatch(matchId, donationAmountWei)
            .send({
              from: fromAddress,
              value: donationAmountWei,
            })
            .on("transactionHash", function (hash) {
              console.log("Transaction hash:", hash);
            })
            .on("receipt", function (receipt) {
              console.log("Receipt:", receipt);
              alert("Donation successful!");
            })
            .on("error", function (error) {
              console.error("Error:", error);
            });
        } catch (error) {
          console.error("Failed to donate to match:", error);
        }
      }

      async function displayCurrentMatches() {
        try {
          const ethPriceInUsd = await getEthPriceInUsd();
          const nextMatchId = await contract.methods.nextMatchId().call();
          const matchesContainer = document.getElementById("matchesContainer");
          matchesContainer.innerHTML = "";

          for (let i = 0; i < nextMatchId; i++) {
            const match = await contract.methods.matches(i).call();
            const totalAmountUsd = (
              web3.utils.fromWei(match.totalAmount, "ether") * ethPriceInUsd
            ).toFixed(2);

            const matchElement = document.createElement("div");
            matchElement.innerHTML = `
                    <p>MATCH ID: ${i}, Player 1: ${
              match.player1
            } vs Player 2: ${
              match.player2
            }, Total amount: $${totalAmountUsd}</p>
                    ${
                      match.isOpen
                        ? `<input type="number" id="matchAmountInput_${i}" placeholder="Enter match amount in USD" step="0.01"/>
                           <button onclick="joinMatch(${i})">Join</button>`
                        : ""
                    }
                  `;
            matchesContainer.appendChild(matchElement);
          }
        } catch (error) {
          console.error("Error displaying current matches:", error);
        }
      }

      async function init() {
        try {
          const isMetaMaskInstalled = await checkMetaMask();
          if (isMetaMaskInstalled) {
            await loginWithMetaMask();
            web3 = new Web3(window.ethereum);
            contract = new web3.eth.Contract(contractABI, contractAddress);
            await updateTransactionData();
            await displayMatchingPoolAmount();
            displayPlayerInfo();
            displayCurrentMatches();

            const loggedInUserWallet = await getLoggedInUserWallet();
            const matchAmountUsd = getURLParameter("match_amount_usd");
            if (matchAmountUsd) {
              document.getElementById("matchAmountUsdInput").value = matchAmountUsd;
              document.getElementById("joinMatchAmountUsdInput").value = matchAmountUsd; // Set the same value for "Join Match" amount
            }
          } else {
            console.error("MetaMask is not installed or not enabled.");
          }
        } catch (error) {
          console.error("Error initializing:", error);
        }
      }

      init();
    </script>
  </body>
</html>
