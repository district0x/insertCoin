<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lobby</title>
    <script src="https://unpkg.com/@metamask/detect-provider/dist/detect-provider.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.5.2/dist/web3.min.js"></script>
    <script src="contractABI.js"></script>
    <style>
        /* Add your CSS styles here */
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Lobby</h1>
            <p id="userAddress"></p>
        </div>
        <div class="content">
            <h2>Player Information</h2>
            <p id="player1"></p>
            <p id="player2"></p>
            <!-- Add other content here -->
        </div>
    </div>

    <script type="text/javascript">
        // Contract address
        const contractAddress = '0x2719D895Fb6a200855c6199E9023803CDC6a4AE7';

        // Web3 initialization
        let web3;

        const userAddressElement = document.getElementById('userAddress');

        async function checkMetaMask() {
            const provider = await detectEthereumProvider();

            if (provider) {
                console.log('MetaMask is installed!');
                return true;
            } else {
                console.log('Please install MetaMask!');
                return false;
            }
        }

        async function loginWithMetaMask() {
            const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
            const address = accounts[0];
            userAddressElement.textContent = 'Logged in with address: ' + address;
            localStorage.setItem('loggedInUserWallet', address);
        }

        async function getLoggedInUserWallet() {
            const accounts = await ethereum.request({ method: 'eth_accounts' });
            return accounts[0];
        }

        async function displayPlayerInfo() {
            const player1Name = getURLParameter('player1');
            const player2Name = getURLParameter('player2');
            
            // Retrieve player wallet addresses from local storage if available
            const player1Wallet = localStorage.getItem('player1_wallet') || '';
            const player2Wallet = localStorage.getItem('player2_wallet') || '';

            document.getElementById('player1').textContent = 'Player 1: ' + player1Name + ' - Wallet: ' + player1Wallet;
            document.getElementById('player2').textContent = 'Player 2: ' + player2Name + ' - Wallet: ' + player2Wallet;
        }

        async function updateTransactionData() {
            const loggedInUserWallet = await getLoggedInUserWallet();
            const player1Name = getURLParameter('player1');
            const player2Name = getURLParameter('player2');

            if (player1Name === loggedInUserWallet) {
                localStorage.setItem('player1_wallet', loggedInUserWallet);
            } else if (player2Name === loggedInUserWallet) {
                localStorage.setItem('player2_wallet', loggedInUserWallet);
            }
        }

        async function getNextLobbyId() {
            const currentLobbyId = await window.contract.methods.getCurrentLobbyId().call();
            return parseInt(currentLobbyId) + 1;
        }

        function getMatchAmountWei() {
            const matchAmount = 0.1; // Example match amount in regular units
            return web3.utils.toWei(matchAmount.toString(), 'ether');
        }

        function getURLParameter(name) {
            const url = window.location.href;
            name = name.replace(/[\[\]]/g, '\\$&');
            const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
            const results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }

        async function init() {
            const isMetaMaskInstalled = await checkMetaMask();
            if (isMetaMaskInstalled) {
                web3 = new Web3(window.ethereum);
                await loginWithMetaMask();
                await updateTransactionData();
                displayPlayerInfo();

                const matchAmountWei = getMatchAmountWei();
                console.log('Match amount in Wei:', matchAmountWei);
            }
        }

        init();
    </script>
</body>
</html>
